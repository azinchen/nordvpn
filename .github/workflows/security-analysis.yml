name: Security Analysis

on:
  schedule:
    - cron: 0 4 * * *
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3.29.1
        with:
          languages: javascript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        id: codeql-analyze
        uses: github/codeql-action/analyze@v3.29.1
        continue-on-error: true
        with:
          category: "/language:javascript"

      - name: Super-Linter
        id: super-linter
        uses: super-linter/super-linter@v7.2.0
        continue-on-error: true
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_DOCKERFILE_HADOLINT: true
          VALIDATE_BASH: true
          VALIDATE_SHELL_SHFMT: true
          VALIDATE_MARKDOWN: true
          VALIDATE_JSON: true
          VALIDATE_YAML: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3.29.1
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-filesystem'

      - name: Run Trivy on Dockerfile
        id: trivy-config
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'config'
          scan-ref: 'Dockerfile'
          format: 'table'

      - name: Run Trivy on Docker Hub Image
        id: trivy-image
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: '${{ github.repository }}:latest'
          format: 'sarif'
          output: 'trivy-image-results.sarif'

      - name: Upload Trivy Docker Image scan results
        uses: github/codeql-action/upload-sarif@v3.29.1
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'
          category: 'trivy-docker-image'

      - name: Run Grype on Docker Hub Image
        id: grype-scan
        continue-on-error: true
        uses: anchore/scan-action@v3.6.4
        with:
          image: '${{ github.repository }}:latest'
          fail-build: false
          severity-cutoff: medium
          output-format: sarif

      - name: Move Grype results to named file
        if: always()
        run: |
          if [ -f "results.sarif" ]; then
            mv results.sarif grype-results.sarif
          fi

      - name: Upload Grype scan results
        uses: github/codeql-action/upload-sarif@v3.29.1
        if: always() && hashFiles('grype-results.sarif') != ''
        with:
          sarif_file: 'grype-results.sarif'
          category: 'grype-docker-image'

      - name: Create scan results archive
        if: always()
        run: |
          # Create directory for scan results
          mkdir -p scan-results
          
          # Copy all scan result files if they exist
          [ -f "trivy-results.sarif" ] && cp trivy-results.sarif scan-results/
          [ -f "trivy-image-results.sarif" ] && cp trivy-image-results.sarif scan-results/
          [ -f "grype-results.sarif" ] && cp grype-results.sarif scan-results/
          [ -f "snyk-results.sarif" ] && cp snyk-results.sarif scan-results/
          
          # Create text summary files for easier reading
          if [ -f "trivy-results.sarif" ]; then
            jq -r '.runs[0].results[] | 
              "TRIVY: \(.message.text // .ruleId) in \(.locations[0].physicalLocation.artifactLocation.uri // "unknown")"' \
              trivy-results.sarif > scan-results/trivy-summary.txt 2>/dev/null || \
              echo "No Trivy filesystem results" > scan-results/trivy-summary.txt
          else
            echo "No Trivy filesystem results" > scan-results/trivy-summary.txt
          fi
          
          if [ -f "trivy-image-results.sarif" ]; then
            jq -r '.runs[0].results[] | 
              "TRIVY-IMAGE: \(.message.text // .ruleId) in \(.locations[0].physicalLocation.artifactLocation.uri // "unknown")"' \
              trivy-image-results.sarif > scan-results/trivy-image-summary.txt 2>/dev/null || \
              echo "No Trivy image results" > scan-results/trivy-image-summary.txt
          else
            echo "No Trivy image results" > scan-results/trivy-image-summary.txt
          fi
          
          if [ -f "grype-results.sarif" ]; then
            jq -r '.runs[0].results[] | 
              "GRYPE: \(.message.text // .ruleId) in \(.locations[0].physicalLocation.artifactLocation.uri // "unknown")"' \
              grype-results.sarif > scan-results/grype-summary.txt 2>/dev/null || \
              echo "No Grype results" > scan-results/grype-summary.txt
          else
            echo "No Grype results" > scan-results/grype-summary.txt
          fi
          
          if [ -f "snyk-results.sarif" ]; then
            jq -r '.runs[0].results[] | 
              "SNYK: \(.message.text // .ruleId) in \(.locations[0].physicalLocation.artifactLocation.uri // "unknown")"' \
              snyk-results.sarif > scan-results/snyk-summary.txt 2>/dev/null || \
              echo "No Snyk results" > scan-results/snyk-summary.txt
          else
            echo "No Snyk results" > scan-results/snyk-summary.txt
          fi
          
          # Create a summary file with scan information
          cat > scan-results/scan-summary.md << 'EOF'
          # Security Scan Results Summary
          EOF
          
          # Add dynamic content to summary
          cat >> scan-results/scan-summary.md << EOF
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Run ID:** ${{ github.run_id }}
          
          ## Files Included
          EOF
          
          # List files in scan-results directory
          ls -la scan-results/ | grep -v "^total" | grep -v "^d" | \
            awk '{print "- " $9 " (" $5 " bytes)"}' >> scan-results/scan-summary.md
          
          # Add tools section
          cat >> scan-results/scan-summary.md << 'EOF'
          
          ## Tools Used
          - **Trivy**: Filesystem and Docker image vulnerability scanning
          - **Grype**: Docker image vulnerability scanning  
          - **Snyk**: Commercial-grade Docker image vulnerability scanning
          - **CodeQL**: Static security analysis
          - **Super-Linter**: Multi-language linting
          
          ## Quick Summary
          EOF
          
          # Add quick summary from text files
          cat scan-results/*-summary.txt 2>/dev/null | head -20 >> scan-results/scan-summary.md || \
            echo "No summary data available" >> scan-results/scan-summary.md
          
          # Add links section
          cat >> scan-results/scan-summary.md << EOF
          
          ## View Results
          - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Security Tab](https://github.com/${{ github.repository }}/security/code-scanning)
          EOF
          
          # Create zip archive with current date
          zip -r "security-scan-results-$(date +%Y%m%d-%H%M%S).zip" scan-results/
          
          # Store the zip filename for later use
          echo "SCAN_RESULTS_ZIP=$(ls security-scan-results-*.zip)" >> $GITHUB_ENV

      - name: Upload scan results as artifact
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: security-scan-results
          path: security-scan-results-*.zip
          retention-days: 30
          compression-level: 0
          if-no-files-found: ignore

      - name: Create Super-Linter Issue
        if: steps.super-linter.outcome == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üîç Linting Issues Found';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## Super-Linter Found Issues
            
            **Files with problems detected in:**
            - Shell scripts
            - Dockerfile
            - Markdown files
            - JSON/YAML files
            
            ### Fix Required
            [View detailed linting results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ${hasZipFile ? `### üìé Scan Results
            Download the complete scan results: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            The zip file contains:
            - SARIF files from all security scanners
            - Detailed scan summary
            - Raw scan outputs` : ''}
            
            **Priority:** Medium
            **Type:** Code Quality
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            `;
            
            // Get existing issues with the same title (without date)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['linting', 'code-quality']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('Linting Issues Found')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates and run IDs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                // Content changed, update the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üîÑ **Issue updated on ${currentDate}** - New linting problems detected.\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` +
                  (hasZipFile ? `\n\nüìé **Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                // Same content, just add a comment about reoccurrence
                const sameIssueComment = `‚ö†Ô∏è **Same linting issues still present on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` +
                  (hasZipFile ? `\n\nüìé **Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameIssueComment
                });
              }
            } else {
              // No existing issue, create new one
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['linting', 'code-quality', 'automated']
              });
            }

      - name: Create Trivy Security Issue
        if: steps.trivy-config.outcome == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üõ°Ô∏è Security Issues Found in Dockerfile';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## Trivy Security Scan Results
            
            **Security misconfigurations found in Dockerfile**
            
            ### Critical Action Required
            [View detailed security results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            [Check Security Tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            
            ${hasZipFile ? `### üìé Complete Scan Results
            Download all security scan results: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            The archive includes:
            - Trivy SARIF results (filesystem & Docker image)
            - Grype & Snyk scan outputs
            - Detailed vulnerability reports
            - Scan summary and metadata
            ` : ''}
            
            **Priority:** High
            **Type:** Security
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            `;
            
            // Get existing security issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'trivy']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('Security Issues Found')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates and run IDs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                // Content changed, update the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üö® **SECURITY ISSUE UPDATED on ${currentDate}** - New or changed security problems detected!\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **High Priority - Please review immediately**` +
                  (hasZipFile ? `\n\nüìé **Detailed Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                // Same content, just add a comment about reoccurrence
                const sameIssueComment = `üî¥ **Same security issues still present on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **Please prioritize fixing these security issues**` +
                  (hasZipFile ? `\n\nüìé **Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameIssueComment
                });
              }
            } else {
              // No existing issue, create new one
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['security', 'trivy', 'automated', 'high-priority']
              });
            }

      - name: Create Trivy Docker Image Issue
        if: steps.trivy-image.outcome == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üê≥ Docker Image Vulnerabilities Found (Trivy)';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## Trivy Docker Image Scan Results
            
            **Vulnerabilities found in Docker Hub image: \`${{ github.repository }}:latest\`**
            
            ### Critical Action Required
            Trivy has detected vulnerabilities in your published Docker image that could affect users.
            
            **Common issues found:**
            - OS package vulnerabilities (Alpine/Ubuntu packages)
            - Application dependency vulnerabilities
            - Base image security issues
            - Outdated system libraries
            
            ### Fix Required
            [View detailed Trivy results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            [Check Security Tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            
            ${hasZipFile ? `### üìé Complete Security Analysis
            Download comprehensive scan results: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            Includes:
            - Trivy vulnerability reports (SARIF format)
            - Cross-reference with Grype and Snyk findings
            - Detailed vulnerability metadata
            - Remediation guidance
            ` : ''}
            
            **Priority:** High
            **Type:** Container Security
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            `;
            
            // Get existing Trivy Docker image issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'trivy', 'docker-image']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('Docker Image Vulnerabilities Found (Trivy)')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates and run IDs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üö® **DOCKER IMAGE VULNERABILITIES UPDATED on ${currentDate}** - New vulnerabilities detected in published image!\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **High Priority - Users may be affected**` +
                  (hasZipFile ? `\n\nüìé **Comprehensive Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                const sameIssueComment = `üî¥ **Same Docker image vulnerabilities still present on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **Please update and republish the Docker image**` +
                  (hasZipFile ? `\n\nüìé **Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameIssueComment
                });
              }
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['security', 'trivy', 'docker-image', 'automated', 'high-priority']
              });
            }

      - name: Create Grype Docker Image Issue
        if: steps.grype-scan.outcome == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üîç Docker Image Vulnerabilities Found (Grype)';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## Grype Docker Image Scan Results
            
            **Vulnerabilities found in Docker Hub image: \`${{ github.repository }}:latest\`**
            
            ### Action Required
            Grype has detected vulnerabilities in your published Docker image.
            
            **Grype specializes in:**
            - Fast vulnerability detection
            - Multiple vulnerability databases
            - Language-specific package vulnerabilities
            - Supply chain security issues
            
            ### Fix Required
            [View detailed Grype results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            [Check Security Tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            
            ${hasZipFile ? `### üìé Multi-Tool Analysis Results
            Download complete vulnerability analysis: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            Compare findings across tools:
            - Grype fast detection results
            - Trivy comprehensive scanning
            - Snyk commercial intelligence
            - Consolidated security assessment
            ` : ''}
            
            **Priority:** Medium
            **Type:** Container Security
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            `;
            
            // Get existing Grype Docker image issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'grype', 'docker-image']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('Docker Image Vulnerabilities Found (Grype)')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates and run IDs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üîÑ **Grype Docker scan updated on ${currentDate}** - New vulnerabilities detected!\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` +
                  (hasZipFile ? `\n\nüìé **Multi-Tool Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                const sameIssueComment = `‚ö†Ô∏è **Same Grype vulnerabilities still present on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` +
                  (hasZipFile ? `\n\nüìé **Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameIssueComment
                });
              }
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['security', 'grype', 'docker-image', 'automated']
              });
            }

      - name: Create CodeQL Security Issue
        if: failure() && steps.codeql-analyze.outcome == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üî¨ CodeQL Security Analysis Issues Found';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## CodeQL Security Analysis Results
            
            **Security vulnerabilities detected by CodeQL static analysis**
            
            ### Critical Action Required
            CodeQL has identified potential security issues in the codebase that require immediate attention.
            
            **Common issues CodeQL finds:**
            - Command injection vulnerabilities
            - Path traversal issues
            - Unsafe string operations
            - Security misconfigurations
            
            ### Fix Required
            [View detailed CodeQL results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            [Check Security Tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            
            ${hasZipFile ? `### üìé Complete Security Analysis Package
            Download full security scan results: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            This package contains:
            - CodeQL static analysis findings
            - Container vulnerability assessments (Trivy, Grype, Snyk)
            - Cross-referenced security analysis
            - Comprehensive security report
            ` : ''}
            
            **Priority:** Critical
            **Type:** Security Vulnerability
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            `;
            
            // Get existing CodeQL security issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'codeql']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('CodeQL Security Analysis Issues Found')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates and run IDs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                // Content changed, update the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üö® **CRITICAL: CodeQL SECURITY ISSUES UPDATED on ${currentDate}** - New security vulnerabilities detected!\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `üî¥ **IMMEDIATE ACTION REQUIRED - Security vulnerabilities found**` +
                  (hasZipFile ? `\n\nüìé **Complete Analysis:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                // Same content, just add a comment about reoccurrence
                const sameIssueComment = `üî¥ **CRITICAL: Same security vulnerabilities still present on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **URGENT: Please prioritize fixing these security vulnerabilities immediately**` +
                  (hasZipFile ? `\n\nüìé **Security Package:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameIssueComment
                });
              }
            } else {
              // No existing issue, create new one
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['security', 'codeql', 'automated', 'critical']
              });
            }

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üö® Code Analysis Failed';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## Code Analysis Failure Report
            
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Commit:** ${context.sha}
            **Branch/Ref:** ${context.ref}
            
            ### What happened?
            The automated code analysis workflow failed. This could be due to:
            - Linting issues found by Super-Linter
            - Security vulnerabilities found by Trivy
            - Configuration problems in Dockerfile
            - Docker image vulnerabilities detected by Grype/Snyk
            
            ### Next Steps
            1. Check the [workflow run logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            2. Review any findings in the [Security tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            3. Fix the identified issues
            4. Close this issue once resolved
            
            ${hasZipFile ? `### üìé Analysis Results Available
            Download complete scan results for detailed analysis: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            The package contains:
            - All SARIF security scan results
            - Detailed vulnerability reports
            - Tool-specific findings
            - Analysis summary and metadata
            ` : ''}
            
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            
            ### Auto-generated
            This issue was automatically created by the code analysis workflow.
            `;
            
            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['automated-analysis', 'bug']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('Code Analysis Failed')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates, run IDs, and commit SHAs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/\*\*Commit:\*\* [a-f0-9]+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                // Content changed, update the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üîÑ **Workflow failure updated on ${currentDate}** - New failure detected with different characteristics.\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` +
                  (hasZipFile ? `\n\nüìé **Analysis Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                // Same type of failure, just add a comment
                const sameFailureComment = `üîÑ **Same failure detected again on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` +
                  (hasZipFile ? `\n\nüìé **Scan Results:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameFailureComment
                });
              }
            } else {
              // No existing issue, create new one
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['automated-analysis', 'bug', 'security']
              });
            }

      - name: Run Snyk to check for vulnerabilities
        id: snyk-scan
        continue-on-error: true
        uses: snyk/actions/docker@14818c4695ecc4045f33c9cee9e795a788711ca4
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: '${{ github.repository }}:latest'
          args: --severity-threshold=medium --file=Dockerfile --sarif-file-output=snyk-results.sarif

      - name: Upload Snyk scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3.29.1
        if: always() && hashFiles('snyk-results.sarif') != ''
        with:
          sarif_file: 'snyk-results.sarif'
          category: 'snyk-docker-image'

      - name: Create Snyk Docker Image Issue
        if: steps.snyk-scan.outcome == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const currentDate = new Date().toISOString().split('T')[0];
            const title = 'üîê Docker Image Vulnerabilities Found (Snyk)';
            
            // Check if scan results zip exists
            const scanResultsZip = process.env.SCAN_RESULTS_ZIP;
            const hasZipFile = scanResultsZip && fs.existsSync(scanResultsZip);
            
            const newBody = `
            ## Snyk Docker Image Scan Results
            
            **Vulnerabilities found in Docker Hub image: \`${{ github.repository }}:latest\`**
            
            ### Critical Action Required
            Snyk has detected vulnerabilities in your published Docker image with advanced commercial intelligence.
            
            **Snyk's enhanced detection covers:**
            - Proprietary vulnerability database with faster updates
            - Advanced exploit detection and prioritization
            - License compliance issues
            - Base image recommendations
            - Detailed fix guidance and remediation steps
            
            ### Fix Required
            [View detailed Snyk results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            [Check Security Tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            
            ${hasZipFile ? `### üìé Premium Security Intelligence Package
            Download enterprise-grade security analysis: [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            This comprehensive package includes:
            - Snyk's commercial vulnerability intelligence
            - Trivy & Grype open-source findings for comparison
            - Cross-tool vulnerability correlation
            - Prioritized remediation recommendations
            - License compliance analysis
            ` : ''}
            
            **Priority:** High
            **Type:** Container Security (Commercial Grade)
            **Last Updated:** ${currentDate}
            **Run ID:** ${context.runId}
            
            ### Why Snyk?
            Snyk provides commercial-grade security intelligence with:
            - Faster vulnerability discovery than open-source tools
            - Better false positive filtering
            - Detailed remediation guidance
            - License compliance checking
            `;
            
            // Get existing Snyk Docker image issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'snyk', 'docker-image']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes('Docker Image Vulnerabilities Found (Snyk)')
            );
            
            if (existingIssue) {
              // Compare content (excluding dates and run IDs)
              const normalizeContent = (content) => {
                return content
                  .replace(/\*\*Last Updated:\*\* \d{4}-\d{2}-\d{2}/g, '')
                  .replace(/\*\*Run ID:\*\* \d+/g, '')
                  .replace(/runs\/\d+/g, 'runs/XXXXX')
                  .replace(/security-scan-results-\d+-\d+\.zip/g, 'security-scan-results-XXXXX.zip')
                  .replace(/\s+/g, ' ')
                  .trim();
              };
              
              const existingNormalized = normalizeContent(existingIssue.body);
              const newNormalized = normalizeContent(newBody);
              
              if (existingNormalized !== newNormalized) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });
                
                const updateComment = `üö® **SNYK VULNERABILITIES UPDATED on ${currentDate}** - New vulnerabilities detected with commercial intelligence!\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **High Priority - Commercial-grade detection**` +
                  (hasZipFile ? `\n\nüìé **Premium Analysis Package:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                });
              } else {
                const sameIssueComment = `üî¥ **Same Snyk vulnerabilities still present on ${currentDate}**\n\n` +
                  `[View latest run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                  `‚ö†Ô∏è **Please review Snyk's detailed fix recommendations**` +
                  (hasZipFile ? `\n\nüìé **Security Intelligence:** [${scanResultsZip}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})` : '');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: sameIssueComment
                });
              }
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: newBody,
                labels: ['security', 'snyk', 'docker-image', 'automated', 'high-priority']
              });
            }
