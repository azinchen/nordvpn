#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

. /usr/local/bin/backend-functions

log "VPN-HEALTHCHECK" "Starting VPN healthcheck script..."

httpreq()
{
    case "$(curl -s --max-time 2 -I "$1" | sed 's/^[^ ]*  *\([0-9]\).*/\1/; 1q')" in
        [23]) return 0;;
        5) return 1;;
        *) return 1;;
    esac
}

counter=1
while [ $counter -le "$check_connection_attempts" ]; do
    # Convert semicolon separated list to space separated
    oldIFS="$IFS"; IFS=',;'
    for url in $check_connection_url; do
        if httpreq "$url"; then
            log "VPN-HEALTHCHECK" "Connection via VPN is up"
            exit 0
        fi
    done
    IFS="$oldIFS"

    sleep "$check_connection_attempt_interval"
    counter=$((counter + 1))
done

log "VPN-HEALTHCHECK" "All connection attempts failed, initiating VPN reconnection"
vpn-reconnect
exit 1
