#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

# Set default values for environment variables
COUNTRY="${COUNTRY:-}"
CITY="${CITY:-}"
TECHNOLOGY="${TECHNOLOGY:-OpenVPN UDP}"
GROUP="${GROUP:-}"
RANDOM_TOP="${RANDOM_TOP:-0}"

nvcountries=$(jq -c '.[]' < "/etc/nordvpn/countries.json")
nvgroups=$(jq -c '.[]' < "/etc/nordvpn/groups.json")
nvtechnologies=$(jq -c '.[]' < "/etc/nordvpn/technologies.json")

numericregex="^[0-9]+$"
specific_server_regex="^[a-zA-Z]{2}[0-9]+$"

ovpntemplatefile="/etc/nordvpn/template.ovpn"
ovpnfile="/tmp/nordvpn.ovpn"

# Helper functions for pattern matching (sh-compatible)
is_numeric() {
    case "$1" in
        ''|*[!0-9]*) return 1 ;;
        *) return 0 ;;
    esac
}

is_specific_server() {
    case "$1" in
        [a-zA-Z][a-zA-Z][0-9]*)
            # Check if it's exactly 2 letters followed by numbers
            prefix=$(echo "$1" | cut -c1-2)
            suffix=$(echo "$1" | cut -c3-)
            case "$prefix" in
                [a-zA-Z][a-zA-Z]) ;;
                *) return 1 ;;
            esac
            case "$suffix" in
                ''|*[!0-9]*) return 1 ;;
                *) return 0 ;;
            esac
            ;;
        *) return 1 ;;
    esac
}

contains_substring() {
    case "$1" in
        *"$2"*) return 0 ;;
        *) return 1 ;;
    esac
}

getcountryid()
{
    input=$1

    if is_numeric "$input"; then
        id=$(echo "$nvcountries" | jq -r --argjson ID "$input" 'select(.id == $ID) | .id')
    else
        id=$(echo "$nvcountries" | jq -r --arg NAME "$input" 'select(.name == $NAME) | .id')
        if [ -z "$id" ]; then
            id=$(echo "$nvcountries" | jq -r --arg CODE "$input" 'select(.code == $CODE) | .id')
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

getcountryname()
{
    input=$1

    if is_numeric "$input"; then
        name=$(echo "$nvcountries" | jq -r --argjson ID "$input" 'select(.id == $ID) | .name')
    else
        name=$(echo "$nvcountries" | jq -r --arg NAME "$input" 'select(.name == $NAME) | .name')
        if [ -z "$name" ]; then
            name=$(echo "$nvcountries" | jq -r --arg CODE "$input" 'select(.code == $CODE) | .name')
        fi
    fi

    printf '%s' "$name"

    if [ -z "$name" ]; then
        return 1
    fi

    return 0
}

getcityid()
{
    input=$1

    if is_numeric "$input"; then
        id=$(echo "$nvcountries" | jq -r --argjson ID "$input" 'select(.cities[]? | .id == $ID) | .cities[] | select(.id == $ID) | .id' | head -n 1)
    else
        id=$(echo "$nvcountries" | jq -r --arg NAME "$input" 'select(.cities[]? | .name == $NAME) | .cities[] | select(.name == $NAME) | .id' | head -n 1)
        if [ -z "$id" ]; then
            id=$(echo "$nvcountries" | jq -r --arg DNS_NAME "$input" 'select(.cities[]? | .dns_name == $DNS_NAME) | .cities[] | select(.dns_name == $DNS_NAME) | .id' | head -n 1)
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

getcityname()
{
    input=$1

    if is_numeric "$input"; then
        name=$(echo "$nvcountries" | jq -r --argjson ID "$input" 'select(.cities[]? | .id == $ID) | .cities[] | select(.id == $ID) | .name' | head -n 1)
    else
        name=$(echo "$nvcountries" | jq -r --arg NAME "$input" 'select(.cities[]? | .name == $NAME) | .cities[] | select(.name == $NAME) | .name' | head -n 1)
        if [ -z "$name" ]; then
            name=$(echo "$nvcountries" | jq -r --arg DNS_NAME "$input" 'select(.cities[]? | .dns_name == $DNS_NAME) | .cities[] | select(.dns_name == $DNS_NAME) | .name' | head -n 1)
        fi
    fi

    printf '%s' "$name"

    if [ -z "$name" ]; then
        return 1
    fi

    return 0
}

getcitycoordinates()
{
    input=$1

    # First get the city ID using existing function
    cityid=$(getcityid "$input")
    if [ -z "$cityid" ]; then
        return 1
    fi

    # Then get coordinates using the city ID
    coords=$(echo "$nvcountries" | jq -r --argjson ID "$cityid" 'select(.cities[]? | .id == $ID) | .cities[] | select(.id == $ID) | "\(.latitude),\(.longitude)"' | head -n 1)

    printf '%s' "$coords"

    if [ -z "$coords" ] || [ "$coords" = "null,null" ]; then
        return 1
    fi

    return 0
}

getgroupid()
{
    input=$1

    if is_numeric "$input"; then
        id=$(echo "$nvgroups" | jq -r --argjson ID "$input" 'select(.id == $ID) | .id')
    else
        id=$(echo "$nvgroups" | jq -r --arg TITLE "$input" 'select(.title == $TITLE) | .id')
        if [ -z "$id" ]; then
            id=$(echo "$nvgroups" | jq -r --arg IDENTIFIER "$input" 'select(.identifier == $IDENTIFIER) | .id')
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

getgrouptitle()
{
    input=$1

    if is_numeric "$input"; then
        title=$(echo "$nvgroups" | jq -r --argjson ID "$input" 'select(.id == $ID) | .title')
    else
        title=$(echo "$nvgroups" | jq -r --arg TITLE "$input" 'select(.title == $TITLE) | .title')
        if [ -z "$title" ]; then
            title=$(echo "$nvgroups" | jq -r --arg IDENTIFIER "$input" 'select(.identifier == $IDENTIFIER) | .title')
        fi
    fi

    printf '%s' "$title"

    if [ -z "$title" ]; then
        return 1
    fi

    return 0
}

gettechnologyid()
{
    input=$1

    if is_numeric "$input"; then
        id=$(echo "$nvtechnologies" | jq -r --argjson ID "$input" 'select(.id == $ID) | .id')
    else
        id=$(echo "$nvtechnologies" | jq -r --arg NAME "$input" 'select(.name == $NAME) | .id')
        if [ -z "$id" ]; then
            id=$(echo "$nvtechnologies" | jq -r --arg IDENTIFIER "$input" 'select(.identifier == $IDENTIFIER) | .id')
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

gettechnologyname()
{
    input=$1

    if is_numeric "$input"; then
        name=$(echo "$nvtechnologies" | jq -r --argjson ID "$input" 'select(.id == $ID) | .name')
    else
        name=$(echo "$nvtechnologies" | jq -r --arg NAME "$input" 'select(.name == $NAME) | .name')
        if [ -z "$name" ]; then
            name=$(echo "$nvtechnologies" | jq -r --arg IDENTIFIER "$input" 'select(.identifier == $IDENTIFIER) | .name')
        fi
    fi

    printf '%s' "$name"

    if [ -z "$name" ]; then
        return 1
    fi

    return 0
}

getopenvpnprotocol()
{
    input=$1

    ident=$(echo "$nvtechnologies" | jq -r --arg NAME "$input" 'select(.name == $NAME) | .identifier')
    if [ -z "$ident" ]; then
        if is_numeric "$input"; then
            ident=$(echo "$nvtechnologies" | jq -r --argjson ID "$input" 'select(.id == $ID) | .identifier')
        fi
    fi
    if [ -z "$ident" ]; then
        ident=$input
    fi

    if ! contains_substring "$ident" "openvpn"; then
        printf ""
        return 1
    elif contains_substring "$ident" "udp"; then
        printf "udp"
        return 0
    elif contains_substring "$ident" "tcp"; then
        printf "tcp"
        return 0
    else
        printf ""
        return 1
    fi
}

handle_specific_server()
{
    value=$1
    
    # Convert to lowercase using tr instead of ${value,,}
    hostname="$(echo "$value" | tr '[:upper:]' '[:lower:]').nordvpn.com"
    ip="$(host -t A "$hostname" | awk '{print $4}')"
    # Extract country code (first 2 chars) and number part
    country_code=$(echo "$value" | cut -c1-2)
    country_num=$(echo "$value" | cut -c3-)
    name="$(getcountryname "$country_code") #$country_num"
    constructed_json=$(printf '{"name":"%s","hostname":"%s","load":0,"station":"%s"}' "$name" "$hostname" "$ip")
    
    printf '%s' "$constructed_json"
}

request_servers()
{
    local filters="$1"
    local description="$2"
    
    if [ -n "$filters" ]; then
        curl_cmd="curl -sG \"https://api.nordvpn.com/v1/servers/recommendations\"$filters"
    else
        curl_cmd="curl -sG \"https://api.nordvpn.com/v1/servers/recommendations\""
    fi
    
    local result=$(eval "$curl_cmd" | jq -c '.[]')
    local count=$(echo "$result" | jq -s 'length')
    
    if [ -n "$description" ]; then
        echo "Request servers$description, $count servers received"
    fi
    
    printf '%s' "$result"
}

echo "Select NordVPN server and create config file"
echo "Apply filter technology \"$(gettechnologyname "$TECHNOLOGY")\", group \"$(getgrouptitle "$GROUP")\""

servers=""
locations_count=0

echo "Request list of recommended servers"

# Validate technology and group IDs and build filter strings
tech_filter=""
if [ -n "$TECHNOLOGY" ]; then
    tech_id=$(gettechnologyid "$TECHNOLOGY")
    if [ -z "$tech_id" ]; then
        echo "Warning: Could not find technology \"$TECHNOLOGY\""
    else
        tech_filter=" --data-urlencode \"filters[servers_technologies][id]=$tech_id\""
    fi
fi

group_filter=""
if [ -n "$GROUP" ]; then
    group_id=$(getgroupid "$GROUP")
    if [ -z "$group_id" ]; then
        echo "Warning: Could not find group \"$GROUP\""
    else
        group_filter=" --data-urlencode \"filters[servers_groups][id]=$group_id\""
    fi
fi

servers=""
locations_count=0

# Process COUNTRY if set
if [ -n "$COUNTRY" ]; then
    # Convert semicolon/comma separated list to space separated  
    countries=$(echo "$COUNTRY" | tr ';,' ' ')
    for value in $countries; do
        if [ -n "$value" ]; then
            locations_count=$((locations_count + 1))
        fi
        if is_specific_server "$value"; then
            servers="$servers$(handle_specific_server "$value")"
        elif [ -n "$value" ]; then
            countryid=$(getcountryid "$value")
            if [ -n "$countryid" ]; then
                # Build filter string and request servers
                country_filter=" --data-urlencode \"filters[country_id]=$countryid\""
                serversincountry=$(request_servers "$country_filter$tech_filter$group_filter" " in \"$(getcountryname "$value")\"")
                servers="$servers""$serversincountry"
            else
                echo "Warning: Could not find country \"$value\""
            fi
        fi
    done
fi

# Process CITY if set
if [ -n "$CITY" ]; then
    # Convert semicolon/comma separated list to space separated  
    cities=$(echo "$CITY" | tr ';,' ' ')
    for value in $cities; do
        if [ -n "$value" ]; then
            locations_count=$((locations_count + 1))
        fi
        if is_specific_server "$value"; then
            servers="$servers$(handle_specific_server "$value")"
        elif [ -n "$value" ]; then
            coords=$(getcitycoordinates "$value")
            if [ -n "$coords" ]; then
                latitude=$(echo "$coords" | cut -d',' -f1)
                longitude=$(echo "$coords" | cut -d',' -f2)
                
                # Build filter string and request servers
                coords_filter=" --data-urlencode \"coordinates[latitude]=$latitude\" --data-urlencode \"coordinates[longitude]=$longitude\""
                serversincity=$(request_servers "$coords_filter$tech_filter$group_filter" " in \"$(getcityname "$value")\"")
                servers="$servers""$serversincity"
            else
                echo "Warning: Could not find coordinates for city \"$value\""
            fi
        fi
    done
fi

poollength=$(echo "$servers" | jq -s 'unique | length')

# If no servers found, fallback to default recommended servers
if [ "$poollength" -eq 0 ]; then
    echo "No servers found for specified criteria, requesting default recommended servers"
    # Try with technology and group filters first
    servers=$(request_servers "$tech_filter$group_filter" "")
    if [ -z "$servers" ]; then
        echo "Warning: Fallback API request failed, trying without filters"
        servers=$(request_servers "" "")
    fi
    poollength=$(echo "$servers" | jq -s 'unique | length')
    echo "Default recommended servers: $(echo "$servers" | jq -s 'length') servers received"
fi

# Only sort by load if multiple locations are specified, otherwise keep recommended order
if [ \( -n "$COUNTRY" \) -o \( -n "$CITY" \) ] && [ "$locations_count" -gt 1 ] && [ "$poollength" -gt 0 ]; then
    # Multiple locations - sort by load and remove duplicates
    servers=$(echo "$servers" | jq -s -c 'unique | sort_by(.load) | .[]')
    echo "Sort servers by load"
else
    # Single location or no location specified - keep recommended order as is
    servers=$(echo "$servers" | jq -s -c '.[]')
fi

if [ "$RANDOM_TOP" -ne 0 ]; then
    if [ "$RANDOM_TOP" -lt "$poollength" ]; then
        filtered=$(echo "$servers" | head -n "$RANDOM_TOP" | shuf)
        servers="$filtered"$(echo "$servers" | tail -n +"$((RANDOM_TOP + 1))")
    else
        servers=$(echo "$servers" | shuf)
    fi
fi

echo "$poollength"" recommended servers in pool"
if [ "$poollength" -ne 0 ]; then
    echo "--- Top 20 servers in filtered pool ---"
    echo "$servers" | jq -r '[.hostname, .load] | "\(.[0]): \(.[1])"' | head -n 20
    echo "---------------------------------------"
fi

if [ "$poollength" -eq 0 ]; then
    echo "ERROR: list of selected servers is empty"
    exit 1
fi

serverip=$(echo "$servers" | jq -r '.station' | head -n 1)
name=$(echo "$servers" | jq -r '.name' | head -n 1)
hostname=$(echo "$servers" | jq -r '.hostname' | head -n 1)
protocol=$(getopenvpnprotocol "$TECHNOLOGY")

echo "Select server \"$name\" hostname=\"$hostname\" ip=\"$serverip\" protocol=\"$protocol\""

cp "$ovpntemplatefile" "$ovpnfile"
chmod 0600 "$ovpnfile"
chown nordvpn:nordvpn "$ovpnfile"

sed -i "s/__IP__/$serverip/g" "$ovpnfile"
sed -i "s/__PROTOCOL__/$protocol/g" "$ovpnfile"
sed -i "s/__X509_NAME__/$hostname/g" "$ovpnfile"

if [ "$protocol" = "udp" ]; then
    sed -i "s/__PORT__/1194/g" "$ovpnfile"
elif [ "$protocol" = "tcp" ]; then
    sed -i "s/__PORT__/443/g" "$ovpnfile"
else
    echo "ERROR: TECHNOLOGY environment variable contains wrong parameter \"$TECHNOLOGY\""
fi

exit 0
