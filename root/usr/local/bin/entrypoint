#!/bin/sh
# shellcheck shell=sh

set -eu

echo "[ENTRYPOINT] Applying immediate security rules..."

# ---- helpers ---------------------------------------------------------------

kernel_ge_4_18()
{
    ver="$(uname -r | awk -F- '{print $1}')"    # e.g., 4.4.0 or 6.8.0
    major="$(echo "$ver" | awk -F. '{print $1}')"
    minor="$(echo "$ver" | awk -F. '{print $2}')"
    [ -n "$minor" ] || minor=0
    if [ "$major" -gt 4 ]; then return 0; fi
    if [ "$major" -lt 4 ]; then return 1; fi
    [ "$minor" -ge 18 ]
}

try_policy()
{
    _bin="$1"
    # Prove backend can change policy on this kernel (DROP then revert)
    $_bin -t filter -S >/dev/null 2>&1 || return 1
    if $_bin -t filter -P OUTPUT DROP >/dev/null 2>&1; then
        $_bin -t filter -P OUTPUT ACCEPT >/dev/null 2>&1 || true
        return 0
    fi
    return 1
}

flush_nft_if_dirty_v4()
{
    # If we selected legacy and nft tables actually have rules, flush them (best effort)
    if [ "${IPT}" = "iptables-legacy" ] && command -v iptables-nft >/dev/null 2>&1; then
        if iptables-nft -S 2>/dev/null | grep -q '^-A ' || iptables-nft -t nat -S 2>/dev/null | grep -q '^-A '; then
            iptables-nft -F 2>/dev/null || true
            iptables-nft -t nat -F 2>/dev/null || true
            iptables-nft -X 2>/dev/null || true
            echo "[ENTRYPOINT] Flushed nft v4 tables to avoid mixed stacks"
        fi
    fi
}

# ---- IPv4 backend picker: prefer nft on â‰¥4.18; else legacy -----------------

pick_ipv4_backend()
{
    IPT=""
    if kernel_ge_4_18; then
        if command -v iptables >/dev/null 2>&1 && iptables -V 2>&1 | grep -qi "(nf_tables)"; then
            try_policy iptables && IPT="iptables"
        fi
        [ -n "$IPT" ] || { command -v iptables-legacy >/dev/null 2>&1 && try_policy iptables-legacy && IPT="iptables-legacy"; }
        [ -n "$IPT" ] || { command -v iptables >/dev/null 2>&1 && try_policy iptables && IPT="iptables"; }
    else
        if command -v iptables-legacy >/dev/null 2>&1; then
            try_policy iptables-legacy && IPT="iptables-legacy"
        fi
        [ -n "$IPT" ] || { command -v iptables >/dev/null 2>&1 && try_policy iptables && IPT="iptables"; }
    fi
    [ -n "$IPT" ] || { echo "[ENTRYPOINT] ERROR: no working iptables (IPv4) found"; exit 1; }

    echo "[ENTRYPOINT] Kernel: $(uname -r)"
    echo "[ENTRYPOINT] Using IPv4 backend: ${IPT}"
    flush_nft_if_dirty_v4
}

pick_ipv4_backend

# After picking IPT
export IPT

# Publish for other scripts
mkdir -p /run/xt
{
    printf 'IPT=%s\n' "$IPT"
} > /run/xt/backend.env

chmod 0644 /run/xt/backend.env

run4() { if ! ${IPT} "$@" 2>/dev/null; then echo "[ENTRYPOINT] (IPv4) skipped: $*"; fi; }

# ---- secure defaults (IPv4 only) -------------------------------------------

# Default DROP policies (set ASAP)
run4 -t filter -P OUTPUT DROP
run4 -t filter -P INPUT  DROP
run4 -t filter -P FORWARD DROP

# Flush existing rules (filter + nat), best effort
run4 -t filter -F; run4 -t filter -X
run4 -t nat    -F; run4 -t nat    -X

# Allow loopback (critical for local apps)
run4 -A INPUT  -i lo -j ACCEPT
run4 -A OUTPUT -o lo -j ACCEPT

echo "[ENTRYPOINT] Critical security rules applied - all traffic blocked by default (IPv4-only)"

exec /init "$@"
