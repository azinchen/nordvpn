#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

echo "[INIT-SETUPCRON] Starting init-setupcron script..."
echo "[INIT-SETUPCRON] Setting up crond service configuration"

cron_dir="/var/spool/cron/crontabs"
cron_file="$cron_dir/root"
echo "[INIT-SETUPCRON] Using cron file: $cron_file"

echo "[INIT-SETUPCRON] Cleaning existing cron file"
rm -f "$cron_file"
touch "$cron_file"

if [ -n "${RECREATE_VPN_CRON:-}" ]; then
    echo "[INIT-SETUPCRON] Creating reconnection cron: $RECREATE_VPN_CRON"
    echo "$RECREATE_VPN_CRON vpn-reconnect" >> "$cron_file"
    echo "[INIT-SETUPCRON] VPN reconnection cron configured"
else
    echo "[INIT-SETUPCRON] No VPN reconnection cron specified"
fi

if [ -n "${CHECK_CONNECTION_CRON:-}" ]; then
    echo "[INIT-SETUPCRON] Creating connectivity check cron: $CHECK_CONNECTION_CRON"
    echo "$CHECK_CONNECTION_CRON vpn-healthcheck" >> "$cron_file"
    echo "[INIT-SETUPCRON] VPN health check cron configured"
else
    echo "[INIT-SETUPCRON] No VPN health check cron specified"
fi

echo "[INIT-SETUPCRON] init-setupcron script completed successfully"
exit 0
