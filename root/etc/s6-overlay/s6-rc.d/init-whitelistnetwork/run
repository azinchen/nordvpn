#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

echo "[INIT-WHITELISTNETWORK] Starting init-whitelistnetwork script..."
echo "[INIT-WHITELISTNETWORK] Setting up bypass rules for domains from whitelist through regular connection"

docker_network="$(ip -o addr show dev eth0 | awk '$3 == "inet" {print $4}')"
docker6_network="$(ip -o addr show dev eth0 | awk '$3 == "inet6" {print $4; exit}')"
echo "[INIT-WHITELISTNETWORK] Detected Docker IPv4 network: ${docker_network:-none}"
echo "[INIT-WHITELISTNETWORK] Detected Docker IPv6 network: ${docker6_network:-none}"

if [ -n "${WHITELIST:-}" ]; then
    echo "[INIT-WHITELISTNETWORK] Processing whitelist domains: ${WHITELIST}"
    # Convert semicolon/comma separated list to space separated
    domains=$(echo "$WHITELIST" | tr ';,' ' ')
    for domain in $domains; do
        domain=$(echo "$domain" | sed 's/^.*:\/\///;s/\/.*$//')
        echo "[INIT-WHITELISTNETWORK] Enabling connection to host $domain"
        if [ -n "${docker_network}" ]; then
            iptables -A OUTPUT -o eth0 -d $domain -j ACCEPT
        fi
        if [ -n "${docker6_network}" ]; then
            ip6tables -A OUTPUT -o eth0 -d $domain -j ACCEPT 2>/dev/null
        fi
    done
    echo "[INIT-WHITELISTNETWORK] Whitelist domains configured"
else
    echo "[INIT-WHITELISTNETWORK] No whitelist domains specified"
fi

echo "[INIT-WHITELISTNETWORK] Setting up bypass for NordVPN API through regular connection"
if [ -n "${docker_network}" ]; then
    echo "[INIT-WHITELISTNETWORK] Resolving api.nordvpn.com IP addresses..."
    api_ips=$(nslookup api.nordvpn.com 2>/dev/null | grep "Address:" | grep -v "#53" | awk '{print $2}' | head -5)
    if [ -n "$api_ips" ]; then
        for api_ip in $api_ips; do
            echo "[INIT-WHITELISTNETWORK] Adding IPv4 rule for api.nordvpn.com IP: $api_ip"
            iptables -A OUTPUT -d "$api_ip" -j ACCEPT
        done
    else
        echo "[INIT-WHITELISTNETWORK] Fallback: Adding IPv4 rule for api.nordvpn.com by name"
        iptables -A OUTPUT -d api.nordvpn.com -j ACCEPT
    fi
fi
if [ -n "${docker6_network}" ]; then
    echo "[INIT-WHITELISTNETWORK] Adding IPv6 rule for api.nordvpn.com"
    ip6tables -A OUTPUT -d api.nordvpn.com -j ACCEPT 2> /dev/null
fi

echo "[INIT-WHITELISTNETWORK] init-whitelistnetwork script completed successfully"
echo "[INIT-WHITELISTNETWORK] DEBUG: Final OUTPUT rules with api.nordvpn.com:"
iptables -L OUTPUT -n -v | grep -E "(api\.nordvpn\.com|104\.19\.|104\.16\.)" || echo "[INIT-WHITELISTNETWORK] No api.nordvpn.com rules found in OUTPUT chain"
exit 0
